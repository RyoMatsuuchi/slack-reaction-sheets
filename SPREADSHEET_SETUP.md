# Google Spreadsheetのセットアップ手順

## 1. Google Cloud Projectの設定

### Google Sheets APIの有効化
1. [Google Cloud Console](https://console.cloud.google.com) にアクセス
2. プロジェクトを選択または作成
3. 左メニューから「APIとサービス」→「APIとサービスを有効化」を選択
4. 検索バーで "Google Sheets API" を検索
5. "Google Sheets API" を選択して「有効にする」をクリック
6. 同様の手順で "Google Drive API" も有効化

### サービスアカウントの作成
1. 左メニューから「IAM と管理」→「サービスアカウント」を選択
2. 「サービスアカウントを作成」をクリック
3. 名前を入力（例：`slack-sheets-sync`）
4. 「作成して続行」をクリック
5. ロールを「編集者」に設定
6. 「完了」をクリック

### サービスアカウントキーの作成
1. 作成したサービスアカウントの一覧から、該当のアカウントをクリック
2. 「キー」タブを選択
3. 「鍵を追加」→「新しい鍵を作成」をクリック
4. キーのタイプは「JSON」を選択
5. 「作成」をクリックしてJSONファイルをダウンロード

## 2. スプレッドシートの作成

1. [Google Drive](https://drive.google.com) にアクセス
2. 新規 → Google スプレッドシートを作成
3. シート名を設定（例：`Slack Messages`）

### ヘッダーの設定
以下のヘッダーを1行目に設定：

```
A列: #
B列: システム
C列: 発生日
D列: 起点(リンク等)
E列: 対応者1
F列: 対応者2
G列: 対応者3
H列: 内容
I列: 完了
J列: 非表示
K列: 調査結果\n対応結果
L列: Support Issue
M列: 関連画面1
N列: 関連画面2
O列: 関連画面3
P列: 関連テーブル1
Q列: 関連テーブル2
R列: 関連テーブル3
```

### A列の設定（オプション）
A列（#）に通し番号を自動的に振るには、A2セルに以下の数式を入力し、必要な範囲までドラッグして複製します：

```
=IF(OR(B2<>"", C2<>""), ROW()-1, "")
```

この数式は：
- B列（システム）またはC列（発生日）に値がある場合、その行番号-1を表示
- どちらも空の場合は空白を表示

## 3. アクセス権限の設定

### サービスアカウントの追加
1. スプレッドシートを開く
2. 「共有」ボタンをクリック
3. サービスアカウントのメールアドレスを追加：
   ```
   slack-sheets-sync@nodal-keep-449707-t7.iam.gserviceaccount.com
   ```
4. 権限を「編集者」に設定
5. 「完了」をクリック

### スプレッドシートIDの取得
1. スプレッドシートのURLから以下の部分をコピー：
   ```
   https://docs.google.com/spreadsheets/d/[このIDをコピー]/edit#gid=0
   ```
2. コピーしたIDを環境変数`GOOGLE_SPREADSHEET_ID`に設定

## 4. 環境変数の設定

### サービスアカウントキーの設定
1. ダウンロードしたJSONファイルの内容をコピー
2. 環境変数`GOOGLE_SERVICE_ACCOUNT_KEY`に設定
   ```
   # .envファイル
   GOOGLE_SERVICE_ACCOUNT_KEY={"type":"service_account",...}
   ```

## 5. 書式設定（オプション）

### ヘッダー行の設定
1. 1行目を選択
2. 背景色を設定（薄いグレー）
3. テキストを太字に設定
4. 中央揃えに設定

### 列幅の調整
- A列（#）: 50px
- B列（システム）: 150px
- C列（発生日）: 100px
- D列（起点）: 150px
- E列（対応者1）: 150px
- H列（内容）: 400px
- その他: 適宜調整

## データ転記仕様

### 行の挿入位置
- C列（発生日）の最後のデータがある行の次の行に挿入
- 行が存在しない場合のみ、新しい行を追加

### 各列の設定
- A列（#）: 既存の値を保持（上書きしない）
- B列（システム）: "i-backyard" に固定
- C列（発生日）: YYYY/MM/DD形式（日本時間）
- D列（起点）: "Slack"という表示でSlackメッセージへのハイパーリンク
- E列（対応者1）: Slackの表示名（display_name）
- I列（完了）: 空欄

## トラブルシューティング

### APIの有効化エラー
対処方法:
1. Google Cloud Consoleで該当のプロジェクトを開く
2. 「APIとサービス」→「APIとサービスを有効化」
3. "Google Sheets API" と "Google Drive API" が有効になっているか確認
4. 有効化後、数分待ってから再試行

### アクセス権限エラー
1. サービスアカウントのメールアドレスが正しく追加されているか確認
2. 権限レベルが「編集者」になっているか確認
3. スプレッドシートIDが正しいか確認

### サービスアカウントキーのエラー
1. JSONファイルの内容が正しく環境変数に設定されているか確認
2. JSONの形式が崩れていないか確認
3. 改行が適切に処理されているか確認
